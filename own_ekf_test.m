
g = 9.81;
l = 0.8;
h = 0.01;

xk_sym = sym('xk',[2,1]);

f = @(x) [x(1)+h*x(2);x(2)-3*g*h/2/l*sin(x(1))];
h = @(x) [1,0]*x;

del_f = matlabFunction(jacobian(f(xk_sym)),'vars',{xk_sym});
del_h = @(x) [1,0];

Q = [3.33210729812411e-07,4.99693512674576e-05;4.99693512674576e-05,0.00999387100513851];
R = 1e-2;

y = [-1.03071386659007,-0.711217982392566,-0.817478121574461,-0.795444500889329,-0.851057487752765,-0.780779044532583,-1.01559705702277,-0.717384552829011,-0.888547893516732,-0.834439215177592,-0.906151886480180,-0.763358368220073,-0.737226911399932,-0.760890976700509,-0.686117523258372,-0.812951505371918,-0.803327500830756,-0.759683055261986,-0.648966161416063,-0.822506225641847,-0.477170806411248,-0.715991918336924,-0.560832089580611,-0.419904458986798,-0.643135098745723,-0.704448846703296,-0.537304635344837,-0.422420584356324,-0.222276947592159,-0.229122174117431,-0.183658788985349,-0.457477131146525,-0.224183863816877,-0.199636916875260,-0.0834538235957256,0.116749571684328,-0.00502799470245442,0.0194990811145606,0.112799950949482,0.0197986202201666,0.143598598296450,0.0845650306221651,0.255943555575172,0.266755128890236,0.191400083853430,0.223871548674556,0.233688459304889,0.282248521585903,0.446219391666092,0.508025145693432,0.398872525582156,0.650978264154062,0.575480982549960,0.872169191270725,0.758068438222738,0.704779459000342,0.681257893742647,0.786927123005098,0.999301971937181,0.753933879087892,0.783308013570035,0.758541062252812,0.750872114809287,0.838822817973592,1.10388011884501,0.928008232649259,1.00054866656744,1.30891494010759,0.810581101441619,0.981876228100510,1.22179303690162,1.05399545812403,1.09245293879756,1.01999146658583,0.987003883028648,1.07186789760577,0.921253134053720,0.918245495824925,0.846109934574427,1.13312767609139,1.14617536457935,1.06049990971581,1.03472182737861,1.00394358139861,0.925904112479291,0.939354340554029,0.861645779751914,0.732895135183338,0.951987909820587,0.920211497081265,0.749967121530548,0.762564051295128,0.752125043547322,0.660158949368571,0.739476560520614,0.438731278467783,0.665285996953962,0.717719522588378,0.500934943044952,0.402460483058029,0.408539092202741,0.376241142956827,0.468886549902075,0.292489737208260,0.432050895008931,0.183639932772171,0.262530634436020,0.0449624368110274,0.160826645839231,0.209213677778833,-0.0286753058758449,0.0840693333459104,0.0246456364958092,-0.0556163473098100,-0.0881414277766287,-0.0263532528204086,-0.244296505497067,-0.174345721325159,-0.401886662484289,-0.378134218060564,-0.410208795898402,-0.427580814399212,-0.496836735445509,-0.381753772147592,-0.508518238461997,-0.587515902336434,-0.608923894113077,-0.616278714367425,-0.807039224989231,-0.668872584736753,-0.703008939266323,-0.751522292566792,-0.825060817482971,-0.832600651199226,-1.01126263037902,-0.882906215314834,-0.970431283053048,-0.998614766232332,-0.987958114542455,-1.00232755606556,-0.962578559490833,-1.12305898012979,-0.998299775342122,-0.977204763216406,-1.09031392454595,-1.25495754607677,-1.09170957637474,-1.18656944445728,-1.06886629110367,-1.16370250823355,-1.27510799791886,-1.23250729557259,-1.20732368095110,-1.21567452448142,-1.09585469856710,-1.14777824965260,-0.958247705022210,-0.935543771175889,-1.11169036490690,-1.05406558096837,-1.04512793158606,-1.13218480468959,-1.04231946768941,-0.975918968300571,-1.22711010980189,-0.976537550936597,-0.840048512438718,-1.03880715372554,-0.953379448348830,-0.785698410324452,-0.789704708900461,-1.09570111553384,-0.669982899706515,-0.717086719781552,-0.729062804166847,-0.829184106957439,-0.510129809395364,-0.362992871730842,-0.643430690874671,-0.376250715501621,-0.578107313043477,-0.520324070047856,-0.415376593535243,-0.455442758402235,-0.235036325535868,-0.221806320154780,-0.123493252797630,-0.226255828577050,0.0151452890920636,-0.0723103586360595,-0.119626605742714,-0.0804849563544309,0.157567589414185,0.0619461006832730,0.254867857193503,0.211890767779804,0.290846469644182,0.430511270349610,0.451562638411432,0.480216039963908,0.647406357795012,0.418188274396900,0.530857070509782,0.473421430948349,0.616171002961800,0.632926552733444,0.782761484264771,0.643887462557366,0.653632687713806,0.853701453455758,0.626715640364478,1.02996266709547,0.912005113477207,0.856367870715503,1.02345616972665,1.09584370983338,0.684852242555565,1.03140697279490,0.987386005707979,1.02265326542141,1.18310941811062,1.01792145713133,1.28516760295450,1.15175208554361,1.06603053685648,1.21389455984402,1.10134336695791,1.02721938590792,1.10741346158799,1.13411880498200,1.21465225424667,0.968617612073235,1.27190619933785,1.39509081656362,1.15796330323090,1.12807428179202,1.23663557859879,1.25928643370717,0.873516745853459,1.16192471328787,0.949243966179601,0.881609521819579,1.05401003553567,0.900133227739246,0.959022391922279,0.870137277361295,0.890957474775672,0.852101725386805,0.878421118123889,0.656957337895753,0.820893643634310,0.722639557221505,0.516355003206523,0.717239858221443,0.638631670240446,0.691261451390966,0.602698895842689,0.427312605807181,0.199228112492699,0.413903496907591,0.198449707133527,0.274972541086003,0.147112913373843,0.214933393465397,0.0825227670299661,-0.0229798025549109,0.0798807989266908,-0.213262499130864,-0.213352971363381,0.0346561177359436,-0.147525834180241,-0.371016211514842,-0.263237197630366,-0.279775194019362,-0.397094649154156,-0.189479827891152,-0.689954202470000,-0.578720809090049,-0.523924842883488,-0.342386605485601,-0.490802513600733,-0.651639769827621,-0.862400153334852,-0.809171712462631,-0.814760798824794,-0.902119888115363,-0.949358138062622,-0.890262611736603,-0.838979960671699,-0.861606662021380,-1.04862853797391,-1.05558346301761,-1.21286128181310,-1.27670207165612,-1.22093717376366,-1.21624220890226,-1.28535462520847,-1.31986386007531,-1.22974132448695,-1.05367538824759,-1.10589860014647,-1.27749174071001,-1.42038195064423,-1.21731035225411,-1.43957724210861,-1.22449416025373,-1.23596332947334,-1.35674366456342,-1.32786744266199,-1.13079014021814,-1.22951255589639,-1.17540866664174,-1.16319682840359,-1.22218633284282,-1.24214408842942,-1.27335585217182,-1.06759952353817,-1.05658653905548,-1.03535296070381,-1.01789548493618,-0.947969535929539,-0.891710818121266,-1.05637098180354,-0.788808637632776,-0.819639492550772,-0.720901837792494,-0.701817726553509,-0.788468760240983,-0.694924665326134,-0.633773995640964,-0.647366484297958,-0.712688590426790,-0.642050726830237,-0.579758141239956,-0.420789350467808,-0.411693799957789,-0.655270276936650,-0.421442759503679,-0.411793296026723,-0.155270808490306,-0.284763702957017,0.00655335126326000,-0.0403636788470541,0.0570061377494786,-0.169752110826940,0.0653917184741486,0.171055908578296,0.196438152139239,0.315230348580774,0.0789280213637340,0.287958869602230,0.571729074007566,0.461646640170397,0.213318147118243,0.264046665058808,0.441402134883652,0.535843030901380,0.536063192550657,0.850686221065513,0.805129424930965,0.760597665510432,0.828747955985505,0.929941700718773,0.634690014241613,0.861270241961155,1.03096795054526,0.943389125830913,0.974463452919054,0.981153037870378,1.13909890007342,1.17843662275586,1.22995843525475,1.15999836617002,1.23608931515884,1.16459573338239,1.26566422820858,1.00322502386015,1.24394847809915,1.41565203110418,1.23267686906363,1.45091371152102,1.45566182318055,1.43154131281087,1.39733257020033,1.42272086589332,1.43804408165654,1.38738456453053,1.32340974086263,1.25042811132394,1.14079750087888,1.30864978356701,1.23506016295582,1.22280216435650,1.18739763349688,1.40282058937405,1.41710219591233,1.13762217877667,1.08163397889313,1.14114591585807,1.33923361762333,1.09394688877478,0.963979609208673,1.01765160651728,1.13013687905332,0.963814183111408,1.09910494990520,0.780076147729326,0.696167895084164,0.798374562719192,0.693392781061886,0.624041637373353,0.579341063818957,0.630669412150064,0.437669311190620,0.473626525585309,0.339614393355517,0.275462190658600,0.303953430846828,0.307543892260274,0.182048571194160,0.203449951773893,0.244326848083336,0.126708000789790,0.0173485226909683,0.149552970700261,-0.138193643222032,-0.168559705051834,-0.284112432123648,-0.144149202052421,-0.346758963696436,-0.433795265920911,-0.435427591438335,-0.623535417260864,-0.555872911190369,-0.511178692782547,-0.634867245658927,-0.589137564920868,-0.722979937495476,-0.896745510688576,-0.811583296820639,-0.780634957416789,-1.02185689813090,-0.929273742619487,-0.872725279105789,-1.09989366215319,-1.33555057611860,-1.15501865754003,-1.09476145020982,-1.07305850725996,-1.35151450240813,-1.39044932900530,-1.39226663376412,-1.39666159147719,-1.39082633235137,-1.53033879068416,-1.52073275110391,-1.27090309233039,-1.52214983090969,-1.24841827773127,-1.52268093417074,-1.33642909204957,-1.33388507965660,-1.61929634359198,-1.43461320147710,-1.42817538016470,-1.55718050786441,-1.54455759483582,-1.37257016840825,-1.52558819729971,-1.67381714291655,-1.60512771797564,-1.51308332762930,-1.54442013899030,-1.53066911829901,-1.42520466733776,-1.60431676611717,-1.48440920266934,-1.33308302634685,-1.37434342850320,-1.33876710331325,-1.16053899106209,-1.28397595009218,-1.03387865636097,-1.12932383481410,-1.13184142342526,-1.25474919083055,-1.27082813179102,-0.925513258537971,-1.05877568047468,-1.15724041274352,-1.03914250401036,-0.789812106716770,-0.924657752710406,-0.745236799757639,-0.887788575500924,-0.716584455580700,-0.740748204618743,-0.787405241623002,-0.569599218163648,-0.561375559526898,-0.413578403808737];

x_hat = [deg2rad(-50);0];
x(:,1) = x_hat;
P_hat = 10*Q;
P(:,:,1) = P_hat;

for i = 2:numel(y)
    [x_pred,P_pred] = EKFPrediction(f,del_f,x(:,i-1),P(:,:,i-1),Q);
    [x(:,i),P(:,:,i)] = EKFUpdate(del_h,h,x_pred,P_pred,R,y(i));
end

function [predicted_EKF_mean_m,predicted_EKF_covar_P] = EKFPrediction( ...
        f, ...
        del_f, ...
        EKF_mean_m, ...
        EKF_covar_P, ...
        process_noise_variance_Q)
    
    predicted_EKF_mean_m = f(EKF_mean_m);
    linear_plant_eval = del_f(EKF_mean_m);
    predicted_EKF_covar_P = linear_plant_eval*EKF_covar_P*linear_plant_eval' ...
        +  process_noise_variance_Q; 
end

function [EKF_mean_m,EKF_covar_P,kalman_gain_K] = EKFUpdate( ...
        del_h, ...
        h, ...
        predicted_EKF_mean_m, ... 
        predicted_EKF_covar_P, ...
        measurement_noise_variance_R, ...
        measurement_z)
    
    linear_measur_eval = del_h(predicted_EKF_mean_m);
    kalman_gain_K = predicted_EKF_covar_P * linear_measur_eval' ...
        /(linear_measur_eval*predicted_EKF_covar_P*linear_measur_eval' ...
        + measurement_noise_variance_R);
    EKF_mean_m = predicted_EKF_mean_m + kalman_gain_K ...
        * (measurement_z - h(predicted_EKF_mean_m));
    EKF_covar_P = ...
        (eye(size(predicted_EKF_covar_P)) - kalman_gain_K*linear_measur_eval) ...
        * predicted_EKF_covar_P;
    EKF_covar_P = 1/2*(EKF_covar_P+EKF_covar_P');
end